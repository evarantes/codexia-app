<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#312e81">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <title>Codexia - Fábrica de Conteúdo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        [v-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="app" class="flex h-screen bg-gray-100" v-cloak>
        
        <!-- Mobile Overlay -->
        <div v-if="mobileMenuOpen" @click="mobileMenuOpen = false" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden"></div>

        <!-- Sidebar -->
        <aside class="bg-indigo-900 text-white flex flex-col fixed inset-y-0 left-0 z-30 transform transition-transform duration-300 w-64 md:relative md:translate-x-0"
               :class="mobileMenuOpen ? 'translate-x-0' : '-translate-x-full'">
            <div class="p-6 text-2xl font-bold flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <i class="fas fa-book-reader"></i> Codexia
                </div>
                <!-- Mobile Close Button -->
                <button @click="mobileMenuOpen = false" class="md:hidden text-white hover:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav class="flex-1 px-4 space-y-2">
                <a href="#" @click="currentTab = 'dashboard'" :class="{'bg-indigo-700': currentTab === 'dashboard'}" class="flex items-center gap-3 py-3 px-4 rounded hover:bg-indigo-700 transition">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="#" @click="currentTab = 'books'" :class="{'bg-indigo-700': currentTab === 'books'}" class="flex items-center gap-3 py-3 px-4 rounded hover:bg-indigo-700 transition">
                    <i class="fas fa-pen-nib"></i> Meus Livros
                </a>
                <a href="#" @click="currentTab = 'campaigns'" :class="{'bg-indigo-700': currentTab === 'campaigns'}" class="flex items-center gap-3 py-3 px-4 rounded hover:bg-indigo-700 transition">
                    <i class="fas fa-bullhorn"></i> Campanhas & IA
                </a>
                <a href="#" @click="currentTab = 'video'" :class="{'bg-indigo-700': currentTab === 'video'}" class="flex items-center gap-3 py-3 px-4 rounded hover:bg-indigo-700 transition">
                    <i class="fas fa-video"></i> Criar Vídeos
                </a>
                <a href="#" @click="currentTab = 'youtube'; fetchYoutubeStats()" :class="{'bg-indigo-700': currentTab === 'youtube'}" class="flex items-center gap-3 py-3 px-4 rounded hover:bg-indigo-700 transition">
                    <i class="fab fa-youtube"></i> YouTube Auto
                </a>
                <a href="#" @click="currentTab = 'book_factory'" :class="{'bg-indigo-700': currentTab === 'book_factory'}" class="flex items-center gap-3 py-3 px-4 rounded hover:bg-indigo-700 transition">
                    <i class="fas fa-industry"></i> Fábrica de Livros
                </a>
                <a href="#" @click="currentTab = 'customers'" :class="{'bg-indigo-700': currentTab === 'customers'}" class="flex items-center gap-3 py-3 px-4 rounded hover:bg-indigo-700 transition">
                    <i class="fas fa-users"></i> Clientes (CRM)
                </a>
                <a href="#" @click="currentTab = 'settings'" :class="{'bg-indigo-700': currentTab === 'settings'}" class="flex items-center gap-3 py-3 px-4 rounded hover:bg-indigo-700 transition">
                    <i class="fas fa-cog"></i> Configurações
                </a>
                <a href="#" @click="logout" class="flex items-center gap-3 py-3 px-4 rounded hover:bg-red-700 transition mt-auto text-red-200 hover:text-white">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </nav>
            <div class="p-4 bg-indigo-950 text-xs text-center text-gray-400">
                Codexia v1.0 Beta
            </div>
        </aside>

        <!-- Main Content Wrapper -->
        <div class="flex-1 flex flex-col overflow-hidden w-full">
            <!-- Mobile Header -->
            <header class="bg-indigo-900 text-white p-4 flex justify-between items-center md:hidden shrink-0">
                <div class="font-bold flex items-center gap-2">
                    <i class="fas fa-book-reader"></i> Codexia
                </div>
                <button @click="mobileMenuOpen = true" class="text-white hover:text-gray-300">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </header>

            <!-- Main Content -->
            <main class="flex-1 overflow-y-auto p-4 md:p-8">
            
            <!-- Dashboard Tab -->
            <div v-if="currentTab === 'dashboard'">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-indigo-500">
                        <div class="text-gray-500">Vendas Totais</div>
                        <div class="text-3xl font-bold">R$ {{ totalSales.toFixed(2) }}</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-green-500">
                        <div class="text-gray-500">Livros Publicados</div>
                        <div class="text-3xl font-bold">{{ books.length }}</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-purple-500">
                        <div class="text-gray-500">Clientes</div>
                        <div class="text-3xl font-bold">{{ customers.length }}</div>
                    </div>
                </div>

                <!-- Monitoring Reports -->
                <div class="bg-white rounded-lg shadow p-6 mb-8" v-if="monitorReports.length > 0">
                    <h2 class="text-xl font-bold mb-4">Relatórios de Monitoramento</h2>
                    <div class="space-y-4 max-h-96 overflow-y-auto">
                        <div v-for="report in monitorReports" :key="report.id" class="border-l-4 border-indigo-500 bg-gray-50 p-4 rounded">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-bold text-indigo-900">Relatório Automático</span>
                                <span class="text-xs text-gray-500">{{ new Date(report.created_at).toLocaleString() }}</span>
                            </div>
                            <div class="text-sm text-gray-700 whitespace-pre-wrap">{{ report.content }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Books Tab -->
            <div v-if="currentTab === 'books'">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Meus Livros</h1>
                    <button @click="openAddBookModal" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                        <i class="fas fa-plus"></i> Novo Livro
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div v-for="book in books" :key="book.id" class="bg-white rounded-lg shadow overflow-hidden">
                        <img :src="book.cover_image_url || 'https://via.placeholder.com/300x400'" class="w-full h-48 object-cover">
                        <div class="p-4">
                            <h3 class="font-bold text-lg mb-1">{{ book.title }}</h3>
                            <p class="text-gray-600 text-sm mb-2">{{ book.author }}</p>
                            <div class="flex justify-between items-center mt-4">
                                <span class="text-green-600 font-bold">R$ {{ book.price }}</span>
                                <div class="flex gap-2">
                                    <button @click="openEditModal(book)" class="text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button>
                                    <button @click="deleteBook(book.id)" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Campaigns Tab -->
            <div v-if="currentTab === 'campaigns'">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Campanhas de Marketing</h1>
                <div class="bg-white p-6 rounded-lg shadow max-w-2xl">
                    <div class="mb-4">
                        <label class="block font-bold mb-2">Livro</label>
                        <select v-model="selectedBookId" class="w-full border p-2 rounded">
                            <option v-for="book in books" :value="book.id">{{ book.title }}</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block font-bold mb-2">Estilo do Anúncio</label>
                        <select v-model="adStyle" class="w-full border p-2 rounded">
                            <option value="cliffhanger">Misterioso (Cliffhanger)</option>
                            <option value="benefit">Benefícios</option>
                            <option value="story">Storytelling</option>
                        </select>
                    </div>
                    <button @click="generateAd" :disabled="loading" class="bg-indigo-600 text-white px-4 py-2 rounded w-full mb-4">
                        <i v-if="loading" class="fas fa-spinner fa-spin"></i> Gerar Anúncio
                    </button>
                    <div v-if="generatedAd">
                        <textarea v-model="generatedAd" class="w-full border p-2 rounded mb-4" rows="6"></textarea>
                        <button @click="postToFacebook" class="bg-blue-600 text-white px-4 py-2 rounded w-full">
                            <i class="fab fa-facebook"></i> Postar no Facebook
                        </button>
                    </div>
                </div>
            </div>

            <!-- Video Tab -->
            <div v-if="currentTab === 'video'">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Criador de Vídeos</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h2 class="text-xl font-bold mb-4">Configuração</h2>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">Baseado em Livro (Opcional)</label>
                            <select v-model="selectedBook" class="w-full border rounded p-2 text-gray-700 bg-white">
                                <option :value="null">-- Selecione um Livro para preencher --</option>
                                <option v-for="book in books" :key="book.id" :value="book">{{ book.title }}</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Ao selecionar, o título e roteiro serão preenchidos automaticamente.</p>
                        </div>

                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">Modo de Criação</label>
                            <select v-model="videoMode" class="w-full border p-2 rounded">
                                <option value="manual">Manual (Roteiro Pronto)</option>
                                <option value="topic">Por Tópico (IA Cria Roteiro)</option>
                                <option value="story">História/Ficção (IA Cria Narrativa)</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="block font-bold mb-2">Título do Vídeo</label>
                            <input v-model="videoTitle" class="w-full border p-2 rounded">
                        </div>

                        <div class="mb-4" v-if="videoMode === 'manual'">
                            <label class="block font-bold mb-2">Roteiro (Linha por Linha)</label>
                            <textarea v-model="videoScript" class="w-full border p-2 rounded" rows="10" placeholder="Digite cada frase do vídeo em uma linha nova..."></textarea>
                        </div>

                        <div class="mb-4" v-if="videoMode === 'topic'">
                            <label class="block font-bold mb-2">Tópico do Vídeo</label>
                            <input v-model="videoContent" class="w-full border p-2 rounded" placeholder="Ex: 5 Dicas para ser mais produtivo">
                            <label class="block font-bold mt-2 mb-2">Duração (minutos)</label>
                            <input type="number" v-model="videoDuration" class="w-full border p-2 rounded" min="1" max="10">
                        </div>

                        <div class="mb-4" v-if="videoMode === 'story'">
                            <label class="block font-bold mb-2">Ideia da História / Prompt</label>
                            <textarea v-model="videoContent" class="w-full border p-2 rounded" rows="5" placeholder="Descreva a história que você quer contar..."></textarea>
                        </div>

                        <button @click="generateVideo" :disabled="videoLoading" class="bg-indigo-600 text-white px-4 py-2 rounded w-full">
                            <i v-if="videoLoading" class="fas fa-spinner fa-spin"></i> Gerar Vídeo
                        </button>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4">Resultado</h2>
                        <div v-if="generatedVideoUrl" class="aspect-w-16 aspect-h-9 bg-black rounded flex items-center justify-center">
                            <video :src="generatedVideoUrl" controls class="w-full h-full"></video>
                        </div>
                        <div v-else class="h-64 bg-gray-100 flex items-center justify-center text-gray-400">
                            O vídeo gerado aparecerá aqui
                        </div>
                        
                        <div v-if="generatedVideoScript" class="mt-4 p-4 bg-gray-50 rounded border max-h-64 overflow-y-auto">
                             <h3 class="font-bold text-sm mb-2">Roteiro Gerado:</h3>
                             <pre class="text-xs whitespace-pre-wrap">{{ JSON.stringify(generatedVideoScript, null, 2) }}</pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- YouTube Tab -->
            <div v-if="currentTab === 'youtube'">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">YouTube Automation</h1>
                
                <!-- Connection & Actions -->
                <div class="bg-white rounded-lg shadow p-6 mb-8">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-4">
                            <div :class="`w-4 h-4 rounded-full ${youtubeStats.connected ? 'bg-green-500' : 'bg-red-500'}`"></div>
                            <div>
                                <h2 class="text-xl font-bold">{{ youtubeStats.title || 'Canal Desconectado' }}</h2>
                                <p class="text-sm text-gray-500">{{ youtubeStats.connected ? 'Monitoramento Ativo (10min)' : 'Conecte seu canal para ativar a automação' }}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button v-if="!youtubeStats.connected" @click="connectYoutube" class="bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700 flex items-center gap-2">
                                <i class="fab fa-youtube"></i> Conectar YouTube
                            </button>
                            <button v-else @click="analyzeChannel" :disabled="ytLoading" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 flex items-center gap-2">
                                <i v-if="ytLoading" class="fas fa-spinner fa-spin"></i>
                                <span v-else><i class="fas fa-magic"></i> Analisar Canal</span>
                            </button>
                        </div>
                    </div>

                    <!-- Optimization Approval Modal -->
                    <div v-if="showOptimizationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-6 rounded-lg w-full max-w-2xl shadow-xl">
                            <h3 class="text-xl font-bold mb-4 text-indigo-900">Aprovar Melhorias</h3>
                            <p class="mb-4 text-gray-600">A IA analisou seu canal e sugeriu as seguintes mudanças. Edite se necessário e confirme.</p>
                            
                            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Título Sugerido</label>
                                    <input v-model="optimizationData.title_suggestion" class="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Descrição</label>
                                    <textarea v-model="optimizationData.description_suggestion" class="w-full border rounded p-2 h-32 focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Prompt para Novo Banner</label>
                                    <textarea v-model="optimizationData.banner_prompt" class="w-full border rounded p-2 h-20 focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                                <button @click="showOptimizationModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                                <button @click="confirmOptimization" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-bold flex items-center gap-2">
                                    <i v-if="ytLoading" class="fas fa-spinner fa-spin"></i>
                                    <span>Aprovar e Aplicar</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Optimization Result -->
                    <div v-if="channelAnalysis" class="mt-6 p-4 bg-indigo-50 rounded border border-indigo-100">
                        <h3 class="font-bold text-indigo-900 mb-2">Relatório de Melhorias</h3>
                        <p class="mb-2">{{ channelAnalysis.message }}</p>
                        <div v-if="channelAnalysis.changes" class="text-sm">
                            <ul class="list-disc pl-5 space-y-1">
                                <li v-for="(change, key) in channelAnalysis.changes" :key="key">
                                    <span class="font-semibold">{{ key }}:</span> {{ change }}
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow flex items-center gap-4">
                        <div class="bg-red-100 p-3 rounded-full text-red-600"><i class="fab fa-youtube text-2xl"></i></div>
                        <div>
                            <div class="text-gray-500">Inscritos</div>
                            <div class="text-2xl font-bold">{{ youtubeStats.subscribers }}</div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow flex items-center gap-4">
                        <div class="bg-blue-100 p-3 rounded-full text-blue-600"><i class="fas fa-eye text-2xl"></i></div>
                        <div>
                            <div class="text-gray-500">Visualizações</div>
                            <div class="text-2xl font-bold">{{ youtubeStats.views }}</div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow flex items-center gap-4">
                        <div class="bg-green-100 p-3 rounded-full text-green-600"><i class="fas fa-video text-2xl"></i></div>
                        <div>
                            <div class="text-gray-500">Vídeos</div>
                            <div class="text-2xl font-bold">{{ youtubeStats.videos }}</div>
                        </div>
                    </div>
                </div>

                <!-- Content Planner -->
                <div class="bg-white rounded-lg shadow p-6 mb-8">
                    <h2 class="text-xl font-bold mb-4">Planejamento Automático de Conteúdo</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div class="md:col-span-2">
                            <label class="block font-bold mb-2">Tema / Nicho</label>
                            <input v-model="scheduleTheme" placeholder="Ex: Dicas de Produtividade, Resumos de Livros..." class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block font-bold mb-2">Tipo</label>
                            <select v-model="scheduleType" class="w-full border p-2 rounded">
                                <option value="days">Dias</option>
                                <option value="weeks">Semanas</option>
                            </select>
                        </div>
                        <div>
                            <label class="block font-bold mb-2">Quantidade (Dias)</label>
                            <input v-model="scheduleQuantity" type="number" min="1" max="30" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block font-bold mb-2">Vídeos/Dia</label>
                            <input v-model="scheduleVideosPerDay" type="number" min="1" max="5" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block font-bold mb-2">Duração (min)</label>
                            <input v-model="scheduleDuration" type="number" min="1" max="15" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block font-bold mb-2">Início</label>
                            <input v-model="scheduleStartDate" type="date" class="w-full border p-2 rounded">
                        </div>
                    </div>
                    <button @click="generateSchedule" :disabled="scheduleLoading" class="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700 w-full flex justify-center items-center gap-2">
                        <i v-if="scheduleLoading" class="fas fa-spinner fa-spin"></i>
                        <span v-else><i class="fas fa-calendar-alt"></i> Gerar Planejamento de Vídeos</span>
                    </button>
                    
                    <!-- Preview of Generated Plan -->
                    <div v-if="schedulePlan.length > 0" class="mt-6">
                        <h3 class="font-bold text-gray-700 mb-4">Prévia do Planejamento (Edite antes de confirmar)</h3>
                        <div class="space-y-4 mb-6">
                            <div v-for="(day, index) in schedulePlan" :key="index" class="bg-gray-50 p-4 rounded border border-gray-200 shadow-sm">
                                <div class="flex justify-between items-center mb-3 border-b pb-2">
                                    <span class="font-bold text-indigo-700">Dia {{ index + 1 }} - {{ day.theme_of_day || 'Geral' }}</span>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-500">Data Base:</span>
                                        <input type="date" v-model="day.date" class="border rounded px-2 py-1 text-sm bg-white">
                                    </div>
                                </div>
                                
                                <!-- Render Videos List if exists -->
                                <div v-if="day.videos && day.videos.length">
                                    <div v-for="(video, vIdx) in day.videos" :key="vIdx" class="ml-2 mb-3 p-3 bg-white border rounded shadow-sm hover:shadow-md transition-shadow">
                                        <div class="mb-2">
                                            <label class="block text-xs font-bold text-gray-500 uppercase">Título</label>
                                            <input v-model="video.title" class="w-full font-bold text-gray-800 border-b border-gray-300 focus:border-indigo-500 outline-none py-1" placeholder="Título do Vídeo">
                                        </div>
                                        <div class="mb-2">
                                            <label class="block text-xs font-bold text-gray-500 uppercase">Roteiro / Conceito</label>
                                            <textarea v-model="video.concept" class="w-full text-sm text-gray-600 border rounded p-2 focus:ring-1 focus:ring-indigo-500 outline-none" rows="2" placeholder="Conceito do vídeo..."></textarea>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-4 bg-gray-50 p-2 rounded mt-2">
                                            <div>
                                                <label class="block text-xs text-gray-500 mb-1">Horário</label>
                                                <input type="time" v-model="video.time" class="w-full border rounded px-2 py-1 text-sm">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-500 mb-1">Automação</label>
                                                <label class="flex items-center text-sm gap-2 cursor-pointer h-full">
                                                    <input type="checkbox" v-model="video.auto_post" class="text-indigo-600 rounded focus:ring-indigo-500">
                                                    <span class="font-medium text-gray-700">Auto Postar</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Fallback for flat structure (if day itself is the video item) -->
                                <div v-else class="ml-2 mb-3 p-3 bg-white border rounded shadow-sm hover:shadow-md transition-shadow">
                                    <div class="mb-2">
                                        <label class="block text-xs font-bold text-gray-500 uppercase">Título</label>
                                        <input v-model="day.title" class="w-full font-bold text-gray-800 border-b border-gray-300 focus:border-indigo-500 outline-none py-1" placeholder="Título do Vídeo">
                                    </div>
                                    <div class="mb-2">
                                        <label class="block text-xs font-bold text-gray-500 uppercase">Roteiro / Conceito</label>
                                        <textarea v-model="day.concept" class="w-full text-sm text-gray-600 border rounded p-2 focus:ring-1 focus:ring-indigo-500 outline-none" rows="2" placeholder="Conceito do vídeo..."></textarea>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4 bg-gray-50 p-2 rounded mt-2">
                                        <div>
                                            <label class="block text-xs text-gray-500 mb-1">Horário</label>
                                            <input type="time" v-model="day.time" class="w-full border rounded px-2 py-1 text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-500 mb-1">Automação</label>
                                            <label class="flex items-center text-sm gap-2 cursor-pointer h-full">
                                                <input type="checkbox" v-model="day.auto_post" class="text-indigo-600 rounded focus:ring-indigo-500">
                                                <span class="font-medium text-gray-700">Auto Postar</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button @click="confirmSchedule" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 w-full shadow-lg transform transition hover:scale-[1.01] flex justify-center items-center gap-2 font-bold text-lg">
                            <i class="fas fa-check-circle"></i> Confirmar e Agendar Produção
                        </button>
                    </div>
                </div>

                <!-- Schedule -->
                <div class="bg-white rounded-lg shadow p-6 mb-8">
                    <h2 class="text-xl font-bold mb-4">Agendamento de Vídeos</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="p-3 text-left">Título</th>
                                    <th class="p-3 text-left">Progresso</th>
                                    <th class="p-3 text-left">Agendado Para</th>
                                    <th class="p-3 text-center">Auto Post</th>
                                    <th class="p-3 text-left">Status</th>
                                    <th class="p-3 text-left">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="video in scheduledVideos" :key="video.id" class="border-t">
                                    <td class="p-3">{{ video.title }}</td>
                                    <td class="p-3 w-32">
                                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                                            <div class="bg-blue-600 h-2.5 rounded-full" :style="{width: (video.progress || 0) + '%'}"></div>
                                        </div>
                                        <div class="text-xs text-center mt-1 text-gray-500">{{ video.progress || 0 }}%</div>
                                    </td>
                                    <td class="p-3">
                                        <input type="datetime-local" v-model="video.scheduled_for_local" class="border rounded p-1 text-sm w-full">
                                    </td>
                                    <td class="p-3 text-center">
                                         <input type="checkbox" v-model="video.auto_post" class="w-4 h-4 text-indigo-600 rounded">
                                    </td>
                                    <td class="p-3">
                                        <span :class="{'bg-yellow-100 text-yellow-800': video.status === 'pending' || video.status === 'queued', 'bg-blue-100 text-blue-800': video.status === 'processing', 'bg-green-100 text-green-800': video.status === 'completed' || video.status === 'published', 'bg-red-100 text-red-800': video.status === 'failed'}" class="px-2 py-1 rounded text-xs font-bold uppercase block text-center">
                                            {{ translateStatus(video.status) }}
                                        </span>
                                    </td>
                                    <td class="p-3 flex gap-2">
                                        <button @click="saveScheduledVideo(video)" class="text-green-600 hover:text-green-800" title="Salvar Alterações"><i class="fas fa-save"></i></button>
                                        <button v-if="video.status === 'completed'" @click="watchScheduledVideo(video)" class="text-blue-600 hover:text-blue-800" title="Assistir"><i class="fas fa-play"></i></button>
                                        <button @click="regenerateScheduledVideo(video)" class="text-orange-600 hover:text-orange-800" title="Regerar"><i class="fas fa-sync"></i></button>
                                        <button @click="deleteScheduledVideo(video)" class="text-red-600 hover:text-red-800" title="Excluir"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Book Factory Tab -->
            <div v-if="currentTab === 'book_factory'">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Fábrica de Livros</h1>
                <p class="text-gray-600 mb-6">Transforme seu manuscrito (Word/PDF) em um livro profissionalmente estruturado com ajuda da IA.</p>
                
                <!-- Step 1: Upload or Create -->
                <div v-if="factoryStep === 1" class="bg-white rounded-lg shadow p-8 max-w-2xl mx-auto">
                    <h2 class="text-xl font-bold mb-6 border-b pb-2">1. Início do Projeto</h2>
                    
                    <div class="flex gap-4 mb-6 border-b pb-4">
                        <button @click="factoryMode = 'upload'" :class="{'border-b-4 border-indigo-600 text-indigo-700 font-bold': factoryMode === 'upload', 'text-gray-500 hover:text-gray-700': factoryMode !== 'upload'}" class="flex-1 py-2 text-center transition">
                            <i class="fas fa-file-upload mr-2"></i> Upload Manuscrito
                        </button>
                        <button @click="factoryMode = 'ai'" :class="{'border-b-4 border-purple-600 text-purple-700 font-bold': factoryMode === 'ai', 'text-gray-500 hover:text-gray-700': factoryMode !== 'ai'}" class="flex-1 py-2 text-center transition">
                            <i class="fas fa-magic mr-2"></i> Monte seu Livro IA
                        </button>
                    </div>

                    <!-- Upload Mode -->
                    <div v-if="factoryMode === 'upload'" class="animate-fade-in">
                        <div class="mb-6">
                            <label class="block font-bold mb-2">Manuscrito (Texto Completo)</label>
                            <input type="file" ref="manuscriptFile" accept=".docx,.pdf" class="w-full border p-3 rounded bg-gray-50">
                            <p class="text-sm text-gray-500 mt-1">Formatos aceitos: .docx, .pdf</p>
                        </div>
                        <button @click="uploadBookMaterial" :disabled="factoryLoading" class="w-full bg-indigo-600 text-white py-3 rounded hover:bg-indigo-700 flex justify-center items-center gap-2 text-lg font-bold">
                            <i v-if="factoryLoading" class="fas fa-spinner fa-spin"></i>
                            <span v-else>Iniciar Análise e Montagem</span>
                        </button>
                    </div>

                    <!-- AI Mode -->
                    <div v-if="factoryMode === 'ai'" class="animate-fade-in">
                        <div class="bg-purple-50 p-4 rounded mb-6 border border-purple-100">
                            <p class="text-purple-800 text-sm"><i class="fas fa-info-circle mr-1"></i> Descreva o livro que você deseja e a IA criará a estrutura, o conteúdo e a capa para você.</p>
                        </div>
                        <div class="space-y-4 mb-6">
                            <div>
                                <label class="block font-bold mb-1">Título do Livro</label>
                                <input v-model="aiBook.title" class="w-full border p-3 rounded" placeholder="Ex: O Segredo da Mente Milionária">
                            </div>
                            <div>
                                <label class="block font-bold mb-1">Sua Solicitação / Ideia Central</label>
                                <textarea v-model="aiBook.idea" class="w-full border p-3 rounded" rows="4" placeholder="Ex: Crie um livro sobre produtividade para empreendedores, focando em gestão de tempo e priorização..."></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block font-bold mb-1">Capítulos</label>
                                    <input v-model="aiBook.num_chapters" type="number" min="1" max="20" class="w-full border p-3 rounded">
                                </div>
                                <div>
                                    <label class="block font-bold mb-1">Páginas (Estimativa)</label>
                                    <input v-model="aiBook.num_pages" type="number" min="10" max="500" class="w-full border p-3 rounded">
                                </div>
                            </div>
                            <div>
                                <label class="block font-bold mb-1">Estilo</label>
                                <select v-model="aiBook.style" class="w-full border p-3 rounded">
                                    <option value="didático">Didático / Educativo</option>
                                    <option value="ficção">Ficção / Romance</option>
                                    <option value="autoajuda">Autoajuda / Motivacional</option>
                                    <option value="técnico">Técnico / Profissional</option>
                                </select>
                            </div>
                        </div>
                        <button @click="createBookFromAI" :disabled="factoryLoading" class="w-full bg-purple-600 text-white py-3 rounded hover:bg-purple-700 flex justify-center items-center gap-2 text-lg font-bold">
                            <i v-if="factoryLoading" class="fas fa-spinner fa-spin"></i>
                            <span v-else><i class="fas fa-robot"></i> Gerar Livro Completo</span>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Configuration Wizard -->
                <div v-if="factoryStep === 2" class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-6 flex justify-between items-center">
                        <span>2. Estrutura e Capa do Livro</span>
                        <div class="flex gap-2">
                            <button @click="previewBook" :disabled="factoryLoading" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 flex items-center gap-2">
                                <i v-if="factoryLoading" class="fas fa-spinner fa-spin"></i>
                                <span v-else><i class="fas fa-eye"></i> Visualizar Prévia</span>
                            </button>
                            <button @click="generateBookPdf" :disabled="factoryLoading" class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700 flex items-center gap-2">
                                <i v-if="factoryLoading" class="fas fa-spinner fa-spin"></i>
                                <span v-else><i class="fas fa-check"></i> Gerar Livro Final (PDF)</span>
                            </button>
                        </div>
                    </h2>

                    <!-- Cover Configuration Section -->
                    <div class="mb-8 p-6 bg-gray-50 rounded border">
                        <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg">
                            <i class="fas fa-image text-indigo-600"></i> Capa do Livro
                        </h3>
                        
                        <div class="flex gap-6 mb-6">
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded border hover:bg-gray-50 shadow-sm">
                                <input type="radio" v-model="coverMode" value="upload" name="coverMode" class="text-indigo-600 focus:ring-indigo-500">
                                <span class="font-medium">Upload Próprio</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded border hover:bg-gray-50 shadow-sm">
                                <input type="radio" v-model="coverMode" value="ai" name="coverMode" class="text-indigo-600 focus:ring-indigo-500">
                                <span class="font-medium">Gerar com IA (3 Sugestões)</span>
                            </label>
                        </div>

                        <!-- Mode: Upload -->
                        <div v-if="coverMode === 'upload'" class="animate-fade-in">
                            <p class="text-sm text-gray-600 mb-2">Faça o upload da imagem da capa (JPG, PNG).</p>
                            <input type="file" ref="step2CoverFile" @change="uploadCover" accept="image/*" class="w-full max-w-md border p-2 rounded bg-white">
                            
                            <div v-if="factoryData.cover_filename" class="mt-4">
                                <div v-if="factoryData.cover_filename.startsWith('http')" class="max-w-xs border rounded shadow-lg overflow-hidden bg-white">
                                    <img :src="factoryData.cover_filename" alt="Capa Gerada" class="w-full h-auto">
                                    <p class="text-center text-xs text-gray-500 py-1 bg-gray-50">Capa sugerida pela IA</p>
                                </div>
                                <div v-else-if="!factoryData.cover_filename.startsWith('covers/')" class="text-green-600 text-sm flex items-center gap-1">
                                    <i class="fas fa-check"></i> Capa carregada: {{ factoryData.cover_filename }}
                                </div>
                            </div>
                        </div>

                        <!-- Mode: AI -->
                        <div v-if="coverMode === 'ai'" class="animate-fade-in">
                            <div v-if="!generatedCovers.length" class="text-center py-6 bg-white rounded border border-dashed">
                                <i class="fas fa-magic text-4xl text-purple-300 mb-3"></i>
                                <p class="text-gray-600 mb-4">A IA irá analisar o conteúdo do seu livro e gerar 3 opções de capa exclusivas.</p>
                                <button @click="generateCovers" :disabled="factoryLoading" 
                                        class="bg-purple-600 text-white px-6 py-2 rounded-full hover:bg-purple-700 disabled:opacity-50 transition shadow-md">
                                    <i v-if="factoryLoading" class="fas fa-spinner fa-spin"></i>
                                    <span v-else>Gerar 3 Sugestões Agora</span>
                                </button>
                            </div>
                            
                            <div v-else>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                                    <div v-for="(cover, idx) in generatedCovers" :key="idx" 
                                        class="relative cursor-pointer border-4 rounded-lg overflow-hidden group shadow-md transition transform hover:scale-105"
                                        :class="{'border-purple-600 ring-2 ring-purple-300': selectedCoverIndex === idx, 'border-white': selectedCoverIndex !== idx}"
                                        @click="selectCover(idx)">
                                        <img :src="cover" class="w-full h-64 object-cover">
                                        <div v-if="selectedCoverIndex === idx" class="absolute inset-0 bg-purple-600 bg-opacity-30 flex items-center justify-center">
                                            <i class="fas fa-check-circle text-white text-4xl drop-shadow-lg"></i>
                                        </div>
                                        <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 text-center opacity-0 group-hover:opacity-100 transition">
                                            Opção {{ idx + 1 }}
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center bg-purple-50 p-3 rounded">
                                    <span class="text-sm text-purple-800 font-medium">
                                        <i class="fas fa-info-circle"></i> Selecione sua capa favorita acima.
                                    </span>
                                    <button @click="generateCovers" :disabled="factoryLoading" class="text-purple-700 hover:text-purple-900 text-sm font-bold flex items-center gap-1">
                                        <i class="fas fa-sync"></i> Solicitar Mais Sugestões
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Navigation / Structure List -->
                        <div class="lg:col-span-1 space-y-4">
                            <h3 class="font-bold text-gray-700 uppercase text-sm border-b pb-1">Metadados</h3>
                            <div class="space-y-2">
                                <input v-model="factoryData.metadata.title" placeholder="Título do Livro" class="w-full border rounded p-2">
                                <input v-model="factoryData.metadata.author" placeholder="Nome do Autor" class="w-full border rounded p-2">
                                <input v-model="factoryData.metadata.subtitle" placeholder="Subtítulo (Opcional)" class="w-full border rounded p-2">
                            </div>

                            <h3 class="font-bold text-gray-700 uppercase text-sm border-b pb-1 mt-6">Pré-Textuais</h3>
                            <div class="space-y-2">
                                <label class="flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <span class="flex items-center gap-2"><input type="checkbox" v-model="factoryData.sections.pre_textual.false_title"> Falsa Folha de Rosto</span>
                                </label>
                                <label class="flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <span class="flex items-center gap-2"><input type="checkbox" v-model="factoryData.sections.pre_textual.title_page"> Folha de Rosto</span>
                                </label>
                                <label class="flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <span class="flex items-center gap-2"><input type="checkbox" v-model="factoryConfig.hasDedication"> Dedicatória</span>
                                    <i class="fas fa-pen text-gray-400 text-xs"></i>
                                </label>
                                <label class="flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <span class="flex items-center gap-2"><input type="checkbox" v-model="factoryConfig.hasAcknowledgments"> Agradecimentos</span>
                                    <i class="fas fa-pen text-gray-400 text-xs"></i>
                                </label>
                                <label class="flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <span class="flex items-center gap-2"><input type="checkbox" v-model="factoryConfig.hasIntroduction"> Introdução</span>
                                    <i class="fas fa-pen text-gray-400 text-xs"></i>
                                </label>
                                <label class="flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <span class="flex items-center gap-2"><input type="checkbox" v-model="factoryConfig.hasEpigraph"> Epígrafe (IA)</span>
                                    <i class="fas fa-magic text-purple-400 text-xs"></i>
                                </label>
                                <label class="flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <span class="flex items-center gap-2"><input type="checkbox" v-model="factoryConfig.hasPreface"> Prefácio</span>
                                </label>
                            </div>

                            <h3 class="font-bold text-gray-700 uppercase text-sm border-b pb-1 mt-6">Pós-Textuais</h3>
                            <div class="space-y-2">
                                <label class="flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <span class="flex items-center gap-2"><input type="checkbox" v-model="factoryConfig.hasEpilogue"> Posfácio/Epílogo</span>
                                </label>
                            </div>
                        </div>

                        <!-- Editor Area -->
                        <div class="lg:col-span-2 bg-gray-50 p-6 rounded border">
                            <h3 class="font-bold mb-4 text-indigo-900">Editor de Conteúdo</h3>
                            
                            <!-- Dedication -->
                            <div v-if="factoryConfig.hasDedication" class="mb-6">
                                <label class="block font-bold text-sm mb-1">Dedicatória</label>
                                <textarea v-model="factoryData.sections.pre_textual.dedication" class="w-full border rounded p-2" rows="3" placeholder="Para quem você dedica este livro?"></textarea>
                            </div>

                            <!-- Acknowledgments -->
                            <div v-if="factoryConfig.hasAcknowledgments" class="mb-6">
                                <label class="block font-bold text-sm mb-1">Agradecimentos</label>
                                <textarea v-model="factoryData.sections.pre_textual.acknowledgments" class="w-full border rounded p-2" rows="4" placeholder="Agradecimentos..."></textarea>
                            </div>

                            <!-- Introduction -->
                            <div v-if="factoryConfig.hasIntroduction" class="mb-6">
                                <label class="block font-bold text-sm mb-1">Introdução</label>
                                <textarea v-model="factoryData.sections.pre_textual.introduction" class="w-full border rounded p-2" rows="6" placeholder="Introdução..."></textarea>
                            </div>

                            <!-- Epigraph -->
                            <div v-if="factoryConfig.hasEpigraph" class="mb-6">
                                <label class="block font-bold text-sm mb-1 flex justify-between">
                                    Epígrafe (Sugestão IA)
                                    <button @click="regenerateSection('epigraph')" class="text-xs text-purple-600 hover:underline"><i class="fas fa-sync"></i> Regenerar</button>
                                </label>
                                <textarea v-model="factoryData.sections.pre_textual.epigraph" class="w-full border rounded p-2" rows="3"></textarea>
                            </div>

                            <!-- Preface -->
                            <div v-if="factoryConfig.hasPreface" class="mb-6">
                                <label class="block font-bold text-sm mb-1 flex justify-between">
                                    Prefácio (Sugestão IA)
                                    <button @click="regenerateSection('preface')" class="text-xs text-purple-600 hover:underline"><i class="fas fa-sync"></i> Regenerar</button>
                                </label>
                                <textarea v-model="factoryData.sections.pre_textual.preface" class="w-full border rounded p-2" rows="6"></textarea>
                            </div>

                            <!-- Chapters Preview (Editable) -->
                            <div class="mt-8 border-t pt-4">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-bold text-gray-600">Estrutura Detectada (Corpo do Texto)</h4>
                                </div>
                                <div class="space-y-4">
                                    <div v-for="(chapter, idx) in factoryData.sections.textual" :key="idx" class="border rounded p-4 bg-white">
                                        <input v-model="chapter.title" class="font-bold w-full mb-2 border-b border-transparent hover:border-gray-300 focus:border-indigo-500 outline-none" placeholder="Título do Capítulo">
                                        <textarea v-model="chapter.content" class="w-full text-sm text-gray-600 border rounded p-2" rows="4"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Epilogue -->
                            <div v-if="factoryConfig.hasEpilogue" class="mt-8 border-t pt-4">
                                <label class="block font-bold text-sm mb-1">Posfácio/Epílogo</label>
                                <textarea v-model="factoryData.sections.post_textual.epilogue" class="w-full border rounded p-2" rows="4"></textarea>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- Customers Tab -->
            <div v-if="currentTab === 'customers'">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Clientes (CRM)</h1>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-4 text-left">Nome</th>
                                <th class="p-4 text-left">Email</th>
                                <th class="p-4 text-left">Data Cadastro</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="customer in customers" :key="customer.id" class="border-t hover:bg-gray-50">
                                <td class="p-4">{{ customer.name }}</td>
                                <td class="p-4">{{ customer.email }}</td>
                                <td class="p-4">{{ new Date(customer.created_at).toLocaleDateString() }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div v-if="currentTab === 'settings'">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Configurações</h1>
                <div class="bg-white p-6 rounded-lg shadow max-w-2xl">
                    <div class="mb-4">
                        <label class="block font-bold mb-2">OpenAI API Key</label>
                        <input v-model="settings.openai_api_key" type="password" class="w-full border p-2 rounded">
                    </div>
                    <div class="mb-4">
                        <label class="block font-bold mb-2">Mercado Pago Access Token</label>
                        <input v-model="settings.mercadopago_access_token" type="password" class="w-full border p-2 rounded">
                    </div>
                    <div class="mb-4">
                        <label class="block font-bold mb-2">YouTube Client ID</label>
                        <input v-model="settings.youtube_client_id" class="w-full border p-2 rounded">
                    </div>
                    <div class="mb-4">
                        <label class="block font-bold mb-2">YouTube Client Secret</label>
                        <input v-model="settings.youtube_client_secret" type="password" class="w-full border p-2 rounded">
                    </div>
                    <div class="mb-4">
                        <label class="block font-bold mb-2">YouTube Refresh Token</label>
                        <input v-model="settings.youtube_refresh_token" type="password" class="w-full border p-2 rounded">
                    </div>
                    <div class="mb-4">
                        <label class="block font-bold mb-2">Facebook Page ID</label>
                        <input v-model="settings.facebook_page_id" class="w-full border p-2 rounded">
                    </div>
                    <div class="mb-4">
                        <label class="block font-bold mb-2">Facebook Access Token</label>
                        <input v-model="settings.facebook_access_token" type="password" class="w-full border p-2 rounded">
                    </div>
                    <button @click="saveSettings" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">
                        Salvar Configurações
                    </button>
                    <p v-if="saveMessage" class="mt-4 text-green-600 font-bold">{{ saveMessage }}</p>
                </div>
            </div>

            </main>
        </div>

        <!-- Auth Code Modal -->
        <div v-if="showAuthCodeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
                <h2 class="text-2xl font-bold mb-4">Conectar YouTube</h2>
                <p class="mb-4 text-gray-600">Uma nova janela foi aberta. Autorize o aplicativo, copie o código exibido e cole abaixo.</p>
                <div class="space-y-4">
                    <input v-model="authCode" placeholder="Cole o código aqui" class="w-full border p-2 rounded">
                    <div class="flex justify-end gap-2">
                        <button @click="showAuthCodeModal = false" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
                        <button @click="submitAuthCode" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Conectar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Book Modal -->
        <div v-if="showAddBookModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
                <h2 class="text-2xl font-bold mb-4">{{ isEditing ? 'Editar Livro' : 'Novo Livro' }}</h2>
                <div class="space-y-4">
                    <input v-model="newBook.title" placeholder="Título" class="w-full border p-2 rounded">
                    <input v-model="newBook.author" placeholder="Autor" class="w-full border p-2 rounded">
                    <textarea v-model="newBook.synopsis" placeholder="Sinopse" class="w-full border p-2 rounded"></textarea>
                    <input v-model="newBook.price" type="number" step="0.01" placeholder="Preço" class="w-full border p-2 rounded">
                    <input v-model="newBook.payment_link" placeholder="Link de Pagamento" class="w-full border p-2 rounded">
                    <div>
                        <label class="block text-sm font-bold mb-1">Arquivo do Livro (PDF/DOCX)</label>
                        <input type="file" @change="handleFileUpload" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Capa (Imagem)</label>
                        <input type="file" @change="handleCoverUpload" class="w-full border p-2 rounded">
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button @click="showAddBookModal = false" class="px-4 py-2 text-gray-600">Cancelar</button>
                        <button @click="saveBook" class="bg-indigo-600 text-white px-4 py-2 rounded">Salvar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Change Password Modal -->
        <div v-if="showChangePasswordModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Alterar Senha</h2>
                <p v-if="mustChangePassword" class="mb-4 text-amber-600 font-medium bg-amber-50 p-3 rounded border border-amber-200">
                    <i class="fas fa-exclamation-triangle mr-2"></i> Por segurança, você deve alterar sua senha no primeiro acesso.
                </p>
                <form @submit.prevent="changePassword">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Senha Atual</label>
                        <input v-model="passwordForm.current" type="password" class="w-full border rounded p-2" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Nova Senha</label>
                        <input v-model="passwordForm.new" type="password" class="w-full border rounded p-2" required minlength="6">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Confirmar Nova Senha</label>
                        <input v-model="passwordForm.confirm" type="password" class="w-full border rounded p-2" required minlength="6">
                    </div>
                    <div v-if="passwordMessage" :class="`mb-4 text-sm ${passwordMessageType === 'error' ? 'text-red-600' : 'text-green-600'}`">
                        {{ passwordMessage }}
                    </div>
                    <div class="flex justify-end gap-2">
                        <button v-if="!mustChangePassword" type="button" @click="showChangePasswordModal = false" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
                        <button type="submit" :disabled="loading" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 disabled:opacity-50">
                            <span v-if="!loading">Alterar Senha</span>
                            <i v-else class="fas fa-spinner fa-spin"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    mobileMenuOpen: false,
                    currentTab: 'dashboard',
                    books: [],
                    selectedBook: null, // New for Video Creator
                    optimizationData: null, // New for Youtube Auto
                    showOptimizationModal: false, // New for Youtube Auto
                    selectedBookId: null,
                    adStyle: 'cliffhanger',
                    generatedAd: '',
                    loading: false,
                    
                    // YouTube Data
                    youtubeStats: {
                        connected: false,
                        title: 'Desconectado',
                        subscribers: 0,
                        views: 0,
                        videos: 0
                    },
                    ytVideoMode: 'topic',
                    ytVideoTopic: '',
                    ytStoryContent: '',
                    ytVideoDuration: 5,
                    ytAutoUpload: false,
                    ytLoading: false,
                    checkingYoutube: true,
                    channelAnalysis: null,
                    generatedVideos: [], // Lista de vídeos gerados
                    monitorReports: [], // Lista de relatórios de monitoramento
                    
                    // Weekly Schedule
                    scheduleTheme: '',
                    scheduleType: 'days',
                    scheduleQuantity: 7,
                    scheduleStartDate: '',
                    schedulePlan: [],
                    scheduleLoading: false,
                    scheduledVideos: [],

                    // Book Factory Data
                    factoryStep: 1,
                    factoryMode: 'upload',
                    aiBook: {
                        title: '',
                        idea: '',
                        num_chapters: 5,
                        num_pages: 50,
                        style: 'didático'
                    },
                    factoryLoading: false,
                    showPreviewModal: false,
                    previewUrl: null,
                    generatedBookUrl: null,
                    
                    // Cover Logic
                    coverMode: 'upload',
                    generatedCovers: [],
                    previewCoverUrl: null,
                    selectedCoverIndex: null,

                    factoryConfig: {
                        hasDedication: false,
                        hasAcknowledgments: false,
                        hasIntroduction: false,
                        hasEpigraph: true,
                        hasPreface: false,
                        hasEpilogue: false
                    },
                    factoryData: {
                        metadata: { title: '', author: '', subtitle: '' },
                        cover_filename: null,
                        raw_text_preview: '',
                        sections: {
                            pre_textual: {
                                false_title: true,
                                title_page: true,
                                copyright: { text: "Copyright © 2025" },
                                dedication: "",
                                acknowledgments: "",
                                introduction: "",
                                epigraph: "",
                                preface: ""
                            },
                            textual: [], // Array of {title: "...", content: "..."}
                            post_textual: {
                                epilogue: ""
                            }
                        }
                    },
                    
                    // Task Tracking
                    currentTaskId: null,
                    taskStatus: null, // pending, processing, completed, failed
                    taskProgress: 0,
                    taskMessage: '',
                    taskResult: null,
                    pollingInterval: null,

                    // Video
                    selectedVideoBookId: null,
                    videoMode: 'manual', // manual, topic, story
                    videoTitle: 'A Hora da Virada',
                    videoContent: '', // Shared for script/topic/story prompt
                    videoDuration: 1,
                    videoLoading: false,
                    generatedVideoUrl: null,

                    // Books
                    showAddBookModal: false,
                    isEditing: false,
                    editingBookId: null,
                    newBook: {
                        title: '',
                        author: '',
                        synopsis: '',
                        price: 0.0,
                        payment_link: 'http://link_padrao',
                        file: null,
                        cover_file: null
                    },

                    // CRM
                    customers: [],
                    sales: [],

                    // Settings
                    settings: {
                        openai_api_key: '',
                        youtube_client_id: '',
                        youtube_client_secret: '',
                        youtube_refresh_token: '',
                        facebook_page_id: '',
                        facebook_access_token: '',
                        mercadopago_access_token: ''
                    },
                    saveMessage: '',

                    // Auth
                    showAuthCodeModal: false,
                    authCode: '',
                    showChangePasswordModal: false,
                    mustChangePassword: false,
                    passwordForm: { current: '', new: '', confirm: '' },
                    passwordMessage: '',
                    passwordMessageType: '',
                    user: null
                }
            },
            computed: {
                totalSales() {
                    return this.sales.reduce((sum, sale) => sum + sale.amount, 0);
                }
            },
            watch: {
                selectedBook(book) {
                    if (book) {
                        this.videoTitle = book.title;
                        this.videoMode = 'manual';
                        let content = "Roteiro Baseado no Livro: " + book.title + "\n\n";
                        if (book.synopsis) content += "Sinopse:\n" + book.synopsis + "\n\n";
                        content += "[Adicione o roteiro detalhado aqui]";
                        this.videoContent = content;
                    }
                }
            },
            async mounted() {
                // Start polling for scheduled videos progress
                setInterval(() => {
                    if (this.scheduledVideos.some(v => v.status === 'processing' || v.status === 'queued')) {
                        this.fetchScheduledVideos();
                    }
                }, 5000);
                
                await this.checkAuth();
                
                await this.fetchBooks();
                await this.fetchSettings();
                await this.fetchCRMData();
                await this.fetchScheduledVideos();
                await this.fetchReports();
                await this.fetchYoutubeStats(); // Check YouTube status on load
                
                // Polling for updates
                setInterval(() => {
                    if (this.currentTab === 'youtube') {
                        this.fetchScheduledVideos();
                        this.fetchReports();
                        this.fetchYoutubeStats(); // Keep status updated
                    }
                }, 10000);
            },
            methods: {
                getAuthHeaders() {
                    const token = localStorage.getItem('access_token');
                    return token ? { 'Authorization': `Bearer ${token}` } : {};
                },
                async authFetch(url, options = {}) {
                    const headers = { ...options.headers, ...this.getAuthHeaders() };
                    const res = await fetch(url, { ...options, headers });
                    if (res.status === 401) {
                        this.logout();
                    }
                    return res;
                },
                async checkAuth() {
                    const token = localStorage.getItem('access_token');
                    if (!token) {
                        window.location.href = '/login.html';
                        return;
                    }
                    
                    try {
                        const res = await fetch('/auth/me', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.user = data;
                            if (data.must_change_password) {
                                this.mustChangePassword = true;
                                this.showChangePasswordModal = true;
                            }
                        } else {
                            this.logout();
                        }
                    } catch (e) {
                        this.logout();
                    }
                },
                logout() {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('must_change_password');
                    window.location.href = '/login.html';
                },
                async changePassword() {
                    if (this.passwordForm.new !== this.passwordForm.confirm) {
                        this.passwordMessage = 'As senhas não coincidem';
                        this.passwordMessageType = 'error';
                        return;
                    }
                    
                    this.loading = true;
                    this.passwordMessage = '';
                    
                    try {
                        const res = await fetch('/auth/change-password', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                            },
                            body: JSON.stringify({
                                current_password: this.passwordForm.current,
                                new_password: this.passwordForm.new
                            })
                        });
                        
                        if (res.ok) {
                            this.passwordMessage = 'Senha alterada com sucesso!';
                            this.passwordMessageType = 'success';
                            this.mustChangePassword = false;
                            setTimeout(() => {
                                this.showChangePasswordModal = false;
                                this.passwordForm = { current: '', new: '', confirm: '' };
                            }, 1500);
                        } else {
                            const data = await res.json();
                            this.passwordMessage = data.detail || 'Erro ao alterar senha';
                            this.passwordMessageType = 'error';
                        }
                    } catch (e) {
                        this.passwordMessage = 'Erro de conexão';
                        this.passwordMessageType = 'error';
                    } finally {
                        this.loading = false;
                    }
                },
                async fetchYoutubeStats() {
                    this.checkingYoutube = true;
                    try {
                        const res = await this.authFetch('/youtube/stats');
                        if (res.ok) {
                            this.youtubeStats = await res.json();
                        } else {
                            this.youtubeStats.connected = false;
                        }
                    } catch (e) {
                        console.error("Error fetching YouTube stats:", e);
                        this.youtubeStats.connected = false;
                    } finally {
                        this.checkingYoutube = false;
                    }
                },
                async connectYoutube() {
                    try {
                        const res = await this.authFetch('/youtube/auth_url');
                        const data = await res.json();
                        if (data.auth_url) {
                            window.location.href = data.auth_url;
                        } else {
                            alert("Erro ao obter URL de autenticação");
                        }
                    } catch (e) {
                        alert("Erro de conexão: " + e);
                    }
                },
                async analyzeChannel() {
                    this.ytLoading = true;
                    this.channelAnalysis = null;
                    try {
                        const res = await this.authFetch('/youtube/optimize', { method: 'POST' });
                        if (res.ok) {
                            this.optimizationData = await res.json();
                            this.showOptimizationModal = true;
                        } else {
                            const err = await res.json();
                            alert("Erro na análise: " + (err.detail || "Desconhecido"));
                        }
                    } catch (e) {
                        alert("Erro de conexão: " + e);
                    } finally {
                        this.ytLoading = false;
                    }
                },
                async confirmOptimization() {
                    this.ytLoading = true;
                    try {
                        const res = await this.authFetch('/youtube/optimize/execute', { 
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                title: this.optimizationData.title_suggestion,
                                description: this.optimizationData.description_suggestion,
                                banner_prompt: this.optimizationData.banner_prompt
                            })
                        });
                        const data = await res.json();
                        
                        this.showOptimizationModal = false;
                        if (res.ok) {
                            this.channelAnalysis = data;
                            this.fetchYoutubeStats();
                            
                            if (data.execution_results) {
                                let msg = "Melhorias aplicadas com sucesso!\n";
                                if (data.execution_results.channel_updated) msg += "- Título e Descrição atualizados\n";
                                if (data.execution_results.banner_uploaded) msg += "- Banner novo gerado e enviado\n";
                                if (data.execution_results.errors && data.execution_results.errors.length > 0) {
                                    msg += "\nErros:\n" + data.execution_results.errors.join("\n");
                                }
                                alert(msg);
                            }
                        } else {
                            alert("Erro ao aplicar melhorias.");
                        }
                    } catch (e) { alert("Erro: " + e); }
                    finally { this.ytLoading = false; }
                },
                async fetchBooks() {
                    try {
                        console.log("Fetching books...");
                        const res = await this.authFetch('/books/');
                        if (!res.ok) throw new Error("Falha na resposta do servidor: " + res.status);
                        this.books = await res.json();
                        console.log("Books loaded:", this.books);
                        if (this.books.length > 0) {
                            this.selectedBookId = this.books[0].id;
                        }
                    } catch (e) { 
                        console.error("Error fetching books:", e); 
                    }
                },
                handleFileUpload(event) {
                    this.newBook.file = event.target.files[0];
                },
                handleCoverUpload(event) {
                    this.newBook.cover_file = event.target.files[0];
                },
                openAddBookModal() {
                    this.isEditing = false;
                    this.editingBookId = null;
                    this.newBook = { title: '', author: '', synopsis: '', price: 0.0, payment_link: 'http://link_padrao', file: null, cover_file: null };
                    this.showAddBookModal = true;
                },
                openEditModal(book) {
                    this.isEditing = true;
                    this.editingBookId = book.id;
                    this.newBook = { ...book, file: null, cover_file: null };
                    this.showAddBookModal = true;
                },
                async deleteBook(id) {
                    if(!confirm("Tem certeza que deseja excluir este livro?")) return;
                    try {
                        const res = await this.authFetch(`/books/${id}`, { method: 'DELETE' });
                        if (res.ok) {
                            alert("Livro excluído com sucesso!");
                            this.fetchBooks();
                        } else {
                            alert("Erro ao excluir livro.");
                        }
                    } catch (e) {
                        alert("Erro ao excluir: " + e);
                    }
                },
                async saveBook() {
                    try {
                        const formData = new FormData();
                        formData.append('title', this.newBook.title);
                        formData.append('author', this.newBook.author);
                        formData.append('synopsis', this.newBook.synopsis);
                        formData.append('price', this.newBook.price);
                        formData.append('payment_link', this.newBook.payment_link);
                        
                        if (this.newBook.file) {
                            formData.append('file', this.newBook.file);
                        }
                        if (this.newBook.cover_file) {
                            formData.append('cover_file', this.newBook.cover_file);
                        }

                        let url = '/books/';
                        let method = 'POST';
                        
                        if (this.isEditing) {
                            url = `/books/${this.editingBookId}`;
                            method = 'PUT';
                        }

                        // Use simple fetch here because FormData is special with headers (Content-Type)
                        // Actually, if we use authFetch, we pass headers. fetch handles FormData Content-Type automatically IF we don't set it.
                        // authFetch adds Authorization. It should be fine.
                        const res = await this.authFetch(url, {
                            method: method,
                            body: formData
                        });

                        if (res.ok) {
                            alert(this.isEditing ? "Livro atualizado!" : "Livro adicionado!");
                            this.showAddBookModal = false;
                            this.newBook = { title: '', author: '', synopsis: '', price: 0.0, payment_link: 'http://link_padrao', file: null, cover_file: null };
                            this.fetchBooks();
                        } else {
                            alert("Erro ao salvar livro");
                        }
                    } catch (e) {
                        alert("Erro ao salvar livro: " + e);
                    }
                },
                async fetchSettings() {
                    try {
                        const res = await this.authFetch('/settings/');
                        this.settings = await res.json();
                    } catch (e) { console.error(e); }
                },
                async fetchCRMData() {
                    try {
                        const custRes = await this.authFetch('/crm/customers');
                        this.customers = await custRes.json();
                        
                        const salesRes = await this.authFetch('/crm/sales');
                        this.sales = await salesRes.json();
                    } catch (e) { console.error(e); }
                },
                // Scheduled Videos Methods
                async fetchScheduledVideos() {
                    try {
                        const res = await this.authFetch('/youtube/schedule');
                        const data = await res.json();
                        this.scheduledVideos = data.map(v => ({
                            ...v,
                            scheduled_for_local: v.scheduled_for ? v.scheduled_for.slice(0, 16) : ''
                        }));
                    } catch (e) { console.error("Erro ao buscar agenda:", e); }
                },
                async saveScheduledVideo(video) {
                    try {
                        const res = await this.authFetch(`/youtube/schedule/${video.id}`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                scheduled_for: video.scheduled_for_local,
                                auto_post: video.auto_post,
                                title: video.title
                            })
                        });
                        if (res.ok) {
                            alert("Agendamento atualizado com sucesso!");
                            this.fetchScheduledVideos();
                        } else {
                            const err = await res.json();
                            alert("Erro ao atualizar agendamento: " + (err.detail || err.message || "Erro desconhecido"));
                        }
                    } catch (e) {
                        alert("Erro: " + e);
                    }
                },
                async fetchReports() {
                    try {
                        const res = await this.authFetch('/youtube/reports');
                        if (res.ok) {
                            this.monitorReports = await res.json();
                        }
                    } catch (e) { console.error(e); }
                },
                translateStatus(status) {
                    const map = {
                        'pending': 'Pendente',
                        'queued': 'Na Fila',
                        'processing': 'Processando',
                        'completed': 'Pronto',
                        'failed': 'Falha'
                    };
                    return map[status] || status;
                },
                async generateSchedule() {
                    if (!this.scheduleTheme) return alert("Digite um tema!");
                    this.scheduleLoading = true;
                    this.schedulePlan = [];
                    try {
                        const res = await this.authFetch('/youtube/schedule/generate', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                theme: this.scheduleTheme,
                                duration_type: this.scheduleType,
                                duration_value: this.scheduleQuantity,
                                start_date: this.scheduleStartDate || undefined
                            })
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.schedulePlan = data.schedule || data; // Adjust based on AI response structure
                        } else {
                            alert("Erro ao gerar planejamento");
                        }
                    } catch (e) {
                        alert("Erro: " + e);
                    } finally {
                        this.scheduleLoading = false;
                    }
                },
                async confirmSchedule() {
                    if (!confirm("Isso agendará a produção de " + this.schedulePlan.length + " itens. Continuar?")) return;
                    this.scheduleLoading = true;
                    try {
                        const res = await this.authFetch('/youtube/schedule/save', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(this.schedulePlan)
                        });
                        if (res.ok) {
                            alert("Agendamento confirmado! Os vídeos entrarão na fila de produção.");
                            this.schedulePlan = [];
                            this.fetchScheduledVideos();
                        } else {
                            let errorMsg = "Erro desconhecido";
                            try {
                                const err = await res.json();
                                errorMsg = err.detail || err.message || JSON.stringify(err);
                            } catch (e) {
                                errorMsg = await res.text();
                            }
                            alert("Falha no Agendamento (Server): " + errorMsg.substring(0, 200));
                            console.error("Erro completo:", errorMsg);
                        }
                    } catch (e) {
                        alert("Erro: " + e);
                    } finally {
                        this.scheduleLoading = false;
                    }
                },
                async regenerateScheduledVideo(video) {
                    if (!confirm("Deseja regenerar este vídeo? O conteúdo atual será perdido.")) return;
                    try {
                        const res = await this.authFetch(`/youtube/schedule/${video.id}/regenerate`, { method: 'POST' });
                        if (res.ok) {
                            alert("Vídeo colocado na fila de regeneração.");
                            this.fetchScheduledVideos();
                        } else {
                            alert("Erro ao solicitar regeneração.");
                        }
                    } catch (e) { alert("Erro: " + e); }
                },
                async deleteScheduledVideo(video) {
                    if (!confirm("Tem certeza que deseja excluir este agendamento?")) return;
                    try {
                        const res = await this.authFetch(`/youtube/schedule/${video.id}`, { method: 'DELETE' });
                        if (res.ok) {
                            this.fetchScheduledVideos();
                        } else {
                            alert("Erro ao excluir.");
                        }
                    } catch (e) { alert("Erro: " + e); }
                },
                watchScheduledVideo(video) {
                     if (video.video_url) {
                        window.open(video.video_url, '_blank');
                     } else {
                         alert("URL do vídeo não disponível.");
                     }
                },
                async saveSettings() {
                    try {
                        const res = await this.authFetch('/settings/', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(this.settings)
                        });
                        if (res.ok) {
                            this.saveMessage = "Configurações salvas com sucesso!";
                            setTimeout(() => this.saveMessage = '', 3000);
                        }
                    } catch (e) { 
                        alert('Erro ao salvar'); 
                    }
                },
                async generateAd() {
                    this.loading = true;
                    try {
                        const res = await this.authFetch('/marketing/generate-ad', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                book_id: this.selectedBookId,
                                style: this.adStyle
                            })
                        });
                        const data = await res.json();
                        this.generatedAd = data.content;
                    } catch (e) {
                        alert("Erro ao gerar anúncio");
                    } finally {
                        this.loading = false;
                    }
                },
                async postToFacebook() {
                    if (!confirm("Tem certeza que deseja postar na Fanpage?")) return;
                    try {
                        const res = await this.authFetch('/marketing/post-to-facebook', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                content: this.generatedAd,
                                book_id: this.selectedBookId
                            })
                        });
                        const data = await res.json();
                        if(data.id) alert("Postado com sucesso! ID: " + data.id);
                        else alert("Erro: " + JSON.stringify(data));
                    } catch (e) {
                        alert("Erro ao postar");
                    }
                },
                async generateVideo() {
                    this.videoLoading = true;
                    this.generatedVideoUrl = null;
                    this.generatedVideoScript = null;
                    
                    try {
                        let content = '';
                        if (this.videoMode === 'manual') {
                             content = this.videoScript;
                        } else {
                             content = this.videoContent;
                        }
                        
                        const res = await this.authFetch('/video/create', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                mode: this.videoMode,
                                title: this.videoTitle,
                                content: content,
                                duration: this.videoDuration
                            })
                        });
                        
                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.detail || "Erro desconhecido");
                        }
                        
                        const data = await res.json();
                        this.generatedVideoUrl = data.video_url;
                        this.generatedVideoScript = data.script;
                    } catch (e) {
                        alert("Erro ao gerar vídeo: " + e.message);
                    } finally {
                        this.videoLoading = false;
                    }
                },
                
                // Book Factory Methods
                async createBookFromAI() {
                    if (!this.aiBook.title || !this.aiBook.idea) {
                        alert("Por favor, preencha o título e a ideia central.");
                        return;
                    }
                    
                    this.factoryLoading = true;
                    try {
                        const res = await this.authFetch('/factory/create_draft', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(this.aiBook)
                        });
                        
                        if (res.ok) {
                            const data = await res.json();
                            this.setupFactoryData(data);
                            this.factoryStep = 2;
                        } else {
                            const err = await res.json();
                            alert("Erro ao gerar livro: " + (err.detail || "Erro desconhecido"));
                        }
                    } catch (e) {
                        alert("Erro de conexão: " + e);
                    } finally {
                        this.factoryLoading = false;
                    }
                },
                
                setupFactoryData(data) {
                    this.factoryData.metadata.title = this.aiBook.title || "Novo Livro";
                    
                    // Cover
                    if (data.cover_filename) {
                        this.factoryData.cover_filename = data.cover_filename;
                        this.coverMode = 'upload'; // Switch to upload mode to show the generated cover
                    }

                    // Suggestions
                    if (data.suggestions) {
                        if (data.suggestions.synopsis) this.factoryData.sections.pre_textual.synopsis = data.suggestions.synopsis;
                        if (data.suggestions.epigraph) { this.factoryConfig.hasEpigraph = true; this.factoryData.sections.pre_textual.epigraph = data.suggestions.epigraph; }
                        if (data.suggestions.preface) { this.factoryConfig.hasPreface = true; this.factoryData.sections.pre_textual.preface = data.suggestions.preface; }
                        if (data.suggestions.dedication) { this.factoryConfig.hasDedication = true; this.factoryData.sections.pre_textual.dedication = data.suggestions.dedication; }
                        if (data.suggestions.acknowledgments) { this.factoryConfig.hasAcknowledgments = true; this.factoryData.sections.pre_textual.acknowledgments = data.suggestions.acknowledgments; }
                        if (data.suggestions.introduction) { this.factoryConfig.hasIntroduction = true; this.factoryData.sections.pre_textual.introduction = data.suggestions.introduction; }
                    }
                    
                    // Chapters
                    if (data.detected_chapters) {
                        this.factoryData.sections.textual = data.detected_chapters.map(c => ({
                            title: c.title,
                            content: c.content
                        }));
                    }
                    
                    this.factoryData.raw_text_preview = data.raw_text_preview;
                },

                async uploadBookMaterial() {
                    const file = this.$refs.manuscriptFile.files[0];
                    if (!file) return alert("Selecione um arquivo!");
                    
                    this.factoryLoading = true;
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    try {
                        const res = await this.authFetch('/factory/upload-manuscript', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await res.json();
                        
                        if (data.analysis) {
                            this.factoryData.metadata.title = data.analysis.title || "";
                            this.factoryData.metadata.author = data.analysis.author || "";
                            this.factoryData.sections.textual = data.analysis.chapters || [];
                            
                            // Detect existing sections
                            if (data.analysis.dedication) { this.factoryConfig.hasDedication = true; this.factoryData.sections.pre_textual.dedication = data.analysis.dedication; }
                            if (data.analysis.acknowledgments) { this.factoryConfig.hasAcknowledgments = true; this.factoryData.sections.pre_textual.acknowledgments = data.analysis.acknowledgments; }
                            if (data.analysis.introduction) { this.factoryConfig.hasIntroduction = true; this.factoryData.sections.pre_textual.introduction = data.analysis.introduction; }
                            if (data.analysis.preface) { this.factoryConfig.hasPreface = true; this.factoryData.sections.pre_textual.preface = data.analysis.preface; }
                            
                            this.factoryStep = 2;
                        }
                    } catch (e) {
                        alert("Erro no upload: " + e);
                    } finally {
                        this.factoryLoading = false;
                    }
                },
                async previewBook() {
                    this.factoryLoading = true;
                    try {
                        const res = await this.authFetch('/factory/generate-preview', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(this.factoryData)
                        });
                        const data = await res.json();
                        if (data.preview_url) {
                            window.open(data.preview_url, '_blank');
                        }
                    } catch (e) {
                        alert("Erro ao gerar prévia: " + e);
                    } finally {
                        this.factoryLoading = false;
                    }
                },
                async generateBookPdf() {
                    this.factoryLoading = true;
                    try {
                        const res = await this.authFetch('/factory/generate-pdf', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(this.factoryData)
                        });
                        const data = await res.json();
                        if (data.pdf_url) {
                            window.open(data.pdf_url, '_blank');
                            // Refresh books list to show new book
                            this.fetchBooks();
                        }
                    } catch (e) {
                        alert("Erro ao gerar PDF final: " + e);
                    } finally {
                        this.factoryLoading = false;
                    }
                },
                async uploadCover(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    try {
                        const res = await this.authFetch('/factory/upload-cover', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await res.json();
                        this.factoryData.cover_filename = data.filename;
                    } catch (e) {
                        console.error(e);
                    }
                },
                async generateCovers() {
                    this.factoryLoading = true;
                    this.generatedCovers = [];
                    try {
                        const res = await this.authFetch('/factory/generate-covers', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                title: this.factoryData.metadata.title,
                                author: this.factoryData.metadata.author,
                                description: this.factoryData.sections.textual.map(c => c.content).join(" ").substring(0, 500)
                            })
                        });
                        const data = await res.json();
                        this.generatedCovers = data.covers;
                    } catch (e) {
                        alert("Erro ao gerar capas: " + e);
                    } finally {
                        this.factoryLoading = false;
                    }
                },
                selectCover(idx) {
                    this.selectedCoverIndex = idx;
                    this.factoryData.cover_filename = this.generatedCovers[idx];
                },
                async regenerateSection(sectionType) {
                    // Logic to call AI for a specific section
                    alert("Funcionalidade de regeneração individual em desenvolvimento.");
                }
            }
        }).mount('#app')
    </script>
</body>
</html>